connections {
    # Section for an IKE connection named <conn>.
{%- for conn in connections %}
    {#- t_id is tunnel_id for downlink #}
    {{ conn.remote }}-{{ conn.t_id }} {
        # IKE major version to use for connection.
        version = 2
        # Local address(es) to use for IKE communication, comma separated.
        local_addrs = %any
        # Remote address(es) to use for IKE communication, comma separated.
        remote_addrs = {{ conn.remote_peer_ip }}
        aggressive = no
        dpd_delay = 30s
        # Continuously tries to reconnect instead of a specific amount of times.
        keyingtries = 0
        # Tries to enforce unique connections, replaces old connection with new.
        unique = keep
        # Default inbound XFRM interface ID for children.
        if_id_in = 0x{{ conn.xfrm_id }}
        # Default outbound XFRM interface ID for children.
        if_id_out = 0x{{ conn.xfrm_id }}
        # Section for a local authentication round.
        local {
            id = {{ conn.local_id }}
            auth = psk
        }
        # Section for a remote authentication round.
        remote {
            id = {{ conn.remote_id }}
            auth = psk
        }
        proposals = aes256-sha384-ecp384
        rekey_time = 24h

        children {
            # CHILD_SA configuration sub-section.
            uplink1 {
                # Local traffic selectors to include in CHILD_SA.
                local_ts = ::/0
                # Remote selectors to include in CHILD_SA.
                remote_ts = ::/0
                life_time = 3960s
                rekey_time = 3600s
                rekey_bytes = 1024000000
                esp_proposals = aes256gcm16-ecp384
                dpd_action = restart
                start_action = start
                close_action = start
            }
        }
    }
{%- endfor %}
}

secrets {
{%- for conn in connections %}
    ike-{{ conn.remote }}-{{ conn.t_id }} {
        id-{{ conn.remote }}-{{ conn.t_id }} = {{ conn.remote_id }}
        secret = "{{ conn.psk }}"
    }
{%- endfor %}
}
