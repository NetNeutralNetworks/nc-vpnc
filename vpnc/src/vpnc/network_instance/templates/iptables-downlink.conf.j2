{#- flush all old configuration and drop all IPv4 traffic by default #}
ip netns exec {{ network_instance_name }} iptables -F
ip netns exec {{ network_instance_name }} iptables -P INPUT DROP
ip netns exec {{ network_instance_name }} iptables -P FORWARD DROP
ip netns exec {{ network_instance_name }} iptables -P OUTPUT DROP

{#- allow forwarded IPv4 traffic from the CORE and related return traffic #}
{%- if mode.name == "ENDPOINT" %}
ip netns exec {{ network_instance_name }} iptables -A INPUT -p icmp -j ACCEPT
  {%- for interface in core_interfaces %}
ip netns exec {{ network_instance_name }} iptables -A FORWARD -i {{ interface }} -j ACCEPT
  {%- endfor%}
ip netns exec {{ network_instance_name }} iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
ip netns exec {{ network_instance_name }} iptables -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
{%- endif %}

{#- flush all old configuration and drop all IPv6 traffic by default #}
{#- except traffic originating from the CORE network instance #}
ip netns exec {{ network_instance_name }} ip6tables -F
ip netns exec {{ network_instance_name }} ip6tables -P INPUT DROP
ip netns exec {{ network_instance_name }} ip6tables -P FORWARD DROP
ip netns exec {{ network_instance_name }} ip6tables -P OUTPUT DROP

{% include 'iptables-icmpv6-in-out.conf.j2' %}


{#- No input #}




{#- allow forwarded IPv6 traffic from the CORE and related return traffic #}
{%- for interface in core_interfaces %}
ip netns exec {{ network_instance_name }} ip6tables -A FORWARD -i {{ interface }} -j ACCEPT
{%- endfor %}
ip netns exec {{ network_instance_name }} ip6tables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT


{%- if mode.name == "ENDPOINT" %}
ip netns exec {{ network_instance_name }} ip6tables -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
{%- endif %}

{% include 'iptables-ipv6-nat.conf.j2' %}
